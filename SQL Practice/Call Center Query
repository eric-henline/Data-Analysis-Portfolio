A telecommunications company charges its customers for both incoming and outgoing calls based on the number of CALL UNITS.  A CALL UNIT is an internal representation of the amount that the company should charge its customers.  It maintains the records of all the calls made on its network in table, CALL RECORD, storing information such as incoming number, outgoing number, duration of the call, and the date on which the call was made.  

The company calculates charges as follows:
- For incoming calls, a standard charge of 1 call unit/second is levied. (Ex: Incoming call of 2 min and 30 sec will charge 150 call units
- For outgoing calls, a fixed charge of 500 call units is charged for the first 2 minutes of a call, then 2 call units/second is levied against the remainder. (Ex: Outgoing call of 3 mintes will charge 620 call untits -- (500 + 60*2))

Write a query to calculate the bills of all the customers for the month of May, 2018.  The results should be in the format: name - phone_number - call_units.

Schema:
table: customer_detail
Name		Type	Description
id		int	customer ID
name		string	customer's name
phone_number	string	customer's phone number

table: call_record
Name		Type	Description
id		int	record ID
incoming_number	string	incoming number
outgoing_number	string	outgoing number
duration	int	call duration in seconds
dialed_on	date	call date

MySQL Query:
-- I used a CTE with a UNION ALL to aggregate the amounts of CALL UNITS for both incoming and outgoing calls.  Then, with a simple query, summed the CALL UNITS and inputted the condition for only in May, 2018 via a WHERE clause.

WITH total_call_units AS (
    (SELECT 
        name, 
        phone_number, 
        dialed_on, 
        SUM(c2.duration) AS amount
    FROM customer_detail AS c1 
    INNER JOIN call_record as c2 ON c1.phone_number = c2.incoming_number
    GROUP BY name, phone_number, dialed_on)
    
UNION ALL

    (SELECT 
        name, 
        phone_number, 
        dialed_on,
        SUM(CASE WHEN c2.duration <= 120 
                THEN 500
            WHEN c2.duration > 120 
                THEN 500+2*(c2.duration-120) 
            END) AS amount
    FROM customer_detail AS c1 
    INNER JOIN call_record as c2 ON c1.phone_number = c2.outgoing_number
    GROUP BY name, phone_number, dialed_on)
    )
    
SELECT 
    name, 
    phone_number, 
    sum(amount) AS call_units
FROM total_call_units
WHERE YEAR(dialed_on) = 2018 
        AND MONTH(dialed_on) = 5
GROUP BY name, phone_number
ORDER BY name;
